# TODO: make the ARCH piece cleaner

ARCH :=x86_64-linux-gnu

INCLUDES :=

# Include top level sources, headers and any other files
# that should be rolled up in a distro tarball
SRCFILES := $(wildcard *.c)

OBJFILES := $(patsubst %.c,%.o, \
		$(filter %.c,$(SRCFILES))) \

# Tools
CC      := $(ARCH)-gcc
LD      := $(ARCH)-ld
AR      := $(ARCH)-ar
OBJCOPY := $(ARCH)-objcopy

# Library names
BASENAME := runchecks

# Flags
CFLAGS  := $(INCLUDES) -MMD -Wall
LDFLAGS := -L.. -ljlibc

.PHONY: all \
	clean distclean mostlyclean maintainer-clean \
	TAGS dist check lint docs \
	notes todo fixme xxx

all: $(BASENAME)
	@echo "Do 'make check' to run tests"

$(BASENAME): $(OBJFILES)
	$(CC) -o $(BASENAME) $^ $(LDFLAGS)

%.o : %.c
	$(CC) $(CFLAGS) -c $< -o $@

clean:
	@# Delete files generated by 'make all'
	-rm $(OBJFILES) $(OBJFILES:.o=.d) $(BASENAME) 2>/dev/null

distclean: clean
	@# Delete files generated by 'configure' and 'make all'

mostlyclean:
	@# Like clean but may refrain from deleting files you
	@#   normally don't want to compile

maintainer-clean: distclean
	@# Delete everything the makefile can build except
	@#   'configure' and files 'configure' needs
	@echo 'This command is intended for maintainers to use; it'
	@echo 'deletes files that may require special tools to rebuild'

TAGS:
	@# Generate ctags

dist:
	@# Make a distribution tarball
	-tar -cv $(SRCFILES) $(ASMFILES) $(HDRFILES) $(AUXFILES) | gzip -c -9 > $(DISTFILE)

check: $(BASENAME)
	@# Perform tests
	@./$(BASENAME)

lint:
	@# Run lint

docs:
	@# Generate documentation

notes: todo fixme xxx
	@# Prints out all TODO, FIXME and XXX comments

todo:
	-@for file in $(SRCFILES) $(ASMFILES) $(HDRFILES); do grep -H TODO  $$file | sed -e 's/:.*TODO/: TODO/'; done; true
fixme:
	-@for file in $(SRCFILES) $(ASMFILES) $(HDRFILES); do grep -H FIXME $$file | sed -e 's/:.*FIXME/: FIXME/'; done; true
xxx:
	-@for file in $(SRCFILES) $(ASMFILES) $(HDRFILES); do grep -H XXX   $$file | sed -e 's/:.*XXX/: XXX/'; done; true

-include $(DEPFILES)
